---
title: "Wild Yeast Report: Vitality and Specific Gravity Study"
date: "`r format(Sys.Date())`"
author:
- Carlie Barnhill^1^*
- Jacob MacPhee^1^*
- Kenneth McLaughlin^1^*

output:
  bookdown::html_document2:
    code_folding: show
    keep_md: yes
    toc: TRUE
    toc_float: TRUE
    toc_depth: 6
    fig_caption: yes
editor_options: 
  markdown: 
    wrap: 72
---
```{css, echo=FALSE}
p.caption {
  font-size: 18px;
}
```


# Affiliations {-}
^1^Mount Allison University, New Brunswick, Canada  

*corresponding author  

# Acknowledgements {-}
Brackets minus after heading excludes heading from numbering.
DAC was supported by the Canada Research Chairs.

# Overview
File import functions read files into R objects, commonly data frames. 

# Materials & Methods  
## Set chunk options
Formatted display of content from .md file on GitHub site.
Upon knitr figures will be saved to 'Figs/'
```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, error = FALSE, message = FALSE)
knitr::opts_chunk$set(fig.path='Figs/')
```

## Load packages
```{r packages, include = FALSE}
# Install the googlesheets4 package if not already installed
# install.packages("googlesheets4")
library(tidyverse) #core packages from Tidyverse
library(googledrive) #access to GoogleDrive
library(googlesheets4) #access to GoogleSheets
```

## InLine Citations of software packages added through the 'citr' option under 'Addins'.  
The cited items must be in the .bib file saved in the .Rproj folder; in this case RPackageCitations.bib, generated by exporting a library to .bib from Zotero.  Upon export click the 'Keep Updated' button in the BetterBibTex menu.  If new citations are added to Zotero they will be pushed through to update the exported .bib file in the .Rproj folder.
[@bryanGooglesheets4AccessGoogle2021;@mcgowanGoogledriveInterfaceGoogle2020; @wickhamTidyverseEasilyInstall2017]

# Import MetaData from a GoogleSheet
MetaData in a GoogleSheet is more generic than a project-specific .csv edited and saved locally.
The GoogleSheet interface can be tricky.
Repeatedly reading from GoogleDrive can provoke a throttle from Google.

```{r Retrieve ATMetaData}
# gs4_auth()

#Instead of sending a token, googlesheets4 will send an API key. This can be used to access public resources for which no Google sign-in is required. 
googlesheets4::gs4_deauth()

# Define the Google Sheet URL (replace with your actual URL)
sheet_url <- "https://docs.google.com/spreadsheets/d/17dDzASxhWDbVpQFXb201vT2oB0rkyi2h4gG33ArOaDA/edit?usp=sharing"

# Read the Google Sheet into R as a data frame
ATMetaData <- read_sheet(sheet_url)

# View the imported data (optional)
#View(ATMetaData)
```



```{r Retrieve MetaData}
# Authenticate with Google Sheets (you only need to do this once)
# gs4_auth()

#Instead of sending a token, googlesheets4 will send an API key. This can be used to access public resources for which no Google sign-in is required. 
googlesheets4::gs4_deauth()

# Define the Google Sheet URL (replace with your actual URL)
sheet_url <- "https://docs.google.com/spreadsheets/d/1HDlxd_bt9I49CQGU18b3h6Df69DG3vQAwbIMZTEdpBQ/edit?usp=sharing"

# Read the Google Sheet into R as a data frame
MetaData <- read_sheet(sheet_url)
#View(MetaData)
```



```{r Retrieve SpecificGravityData}
# Authenticate with Google Sheets (you only need to do this once)
# gs4_auth()

#Instead of sending a token, googlesheets4 will send an API key. This can be used to access public resources for which no Google sign-in is required. 
googlesheets4::gs4_deauth()

# Define the Google Sheet URL (replace with your actual URL)
sheet_url <- "https://docs.google.com/spreadsheets/d/15Qd3DYkeRX4FCy84Uw9ns9L6Bq6P959csP-opdGvBME/edit?usp=sharing"

# Read the Google Sheet into R as a data frame
SpecificGravityData <- read_sheet(sheet_url)

```



```{r Retrieve BrothPlateData}
# Authenticate with Google Sheets (you only need to do this once)
# gs4_auth()

#Instead of sending a token, googlesheets4 will send an API key. This can be used to access public resources for which no Google sign-in is required. 
googlesheets4::gs4_deauth()

# Define the Google Sheet URL (replace with your actual URL)
sheet_url <- "https://docs.google.com/spreadsheets/d/118YF2qZqtC5yCfqyDeRaGQhgm5v8mn6wC_6ae1Rnyik/edit?usp=sharing"

# Read the Google Sheet into R as a data frame
BrothPlateData <- read_sheet(sheet_url)
#View(BrothPlateData)
```



```{r Retrieve DataDictionary}
# Authenticate with Google Sheets (you only need to do this once)
# gs4_auth()

#Instead of sending a token, googlesheets4 will send an API key. This can be used to access public resources for which no Google sign-in is required. 
googlesheets4::gs4_deauth()

# Define the Google Sheet URL (replace with your actual URL)
sheet_url <- "https://docs.google.com/spreadsheets/d/1YN_s-YRdM4j9t_c_l1Z4-Q53KQlURTlDpItovzZNd3g/edit?usp=sharing"

# Read the Google Sheet into R as a data frame
DataDictionnary <- read_sheet(sheet_url)

```

# Merge BrothPlateData with MetaData, via leftjoin().
```{r Merge BrothPlateData with MetaData}
MergedBrothPlateData <- BrothPlateData %>%
  left_join(MetaData, by = "SampleID")
head(MergedBrothPlateData)
```

# Merge SpecificGravityData with MetaData, via leftjoin().
```{r Merge BrothPlateData with MetaData}
MergedSpecificGravityData <- SpecificGravityData %>%
  left_join(MetaData, by = "SampleID")
head(MergedSpecificGravityData)
#View(MergedSpecificGravityData)
```

# Percent of living yeast compared to total yeast from each sample ID containing yeast graphing on bar graph
```{r Viability Percent by Sample ID}
MergedBrothPlateData |> 
filter(!is.na(SampleID)) |> 
filter(!Source %in% c("Air", "Apple", "OakTreeBark")) |> 
ggplot(aes(x = as.factor(Source), y = ViabilityPercent, fill = BrothType, color = BrothType , shape = as.factor(GrowthTempC))) +
geom_point(size = 4) + # Use points
coord_cartesian(ylim = c(0 , 100)) +
geom_text(aes(label = round(ViabilityPercent, 1)), vjust = -0.5, hjust = 1.5, size = 3.25, color = "black", face = "bold") +  
scale_x_discrete(drop = TRUE) +  # Drop unused x-axis levels
labs(title = "Viability Percent by Source, Broth Type and Temperature", x = "Source", y = "Viability Percent (%)", color = "Broth Type", fill = "Broth Type") + 
theme_minimal(base_size = 12) +
theme(strip.text = element_text(size = 10, face = "bold"), axis.text.x = element_text(angle = 0, hjust = 0.5),plot.title = element_text(hjust = 0.5, face = "bold", size = 14))

#theme( axis.text.x = element_text(angle = 0, hjust = 0.5),  # Center x-axis labels
#legend.position = "none")
```

# Final alcohol percent of each sample tested
```{r final alcohol percent of each sample }
# Find initial Specific Gravity (SG) at Time = 0
initial_sg_values <- MergedSpecificGravityData %>%
filter(Time == 0) 

%>%
select(SampleID, SpecificGravity) %>%
rename(InitialSG = SpecificGravity)

# Find final SG for each SampleID
final_sg_values <- MergedSpecificGravityData %>%
group_by(SampleID) %>%
summarize(FinalSG = min(SpecificGravity, na.rm = TRUE), .groups = "drop")

# merge initial SG and final SG into a single dataset
combined_sg_values <- merge(initial_sg_values, final_sg_values, by = "SampleID")

# calculate ABV 
combined_sg_values <- combined_sg_values %>%
mutate(ABV = (InitialSG - FinalSG) * 131.25)
print(combined_sg_values)

#View(combined_sg_values)

```

# The SG of each sample ID versus time collected throught the brewing proccess
```{r Specific Gravity Over Time by Source}
ggplot(MergedSpecificGravityData, aes(x = Time, y = SpecificGravity, color = BrothType , shape = as.factor(GrowthTempC))) +
geom_line(size = 1) + 
geom_point(size = 2) + 
coord_cartesian(ylim = c(0 , 1.5)) +
facet_grid(cols = vars(Source)) +  # Facet by Source
labs(x = "Time", y = "Specific Gravity", color = "Broth Type", title = "Specific Gravity Over Time by Source") +
theme_minimal(base_size = 12) +
theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 14), strip.text = element_text(size = 10, face = "bold"), axis.text.x = element_text(angle = , hjust = 1))
```

# The following code is for the rate of fermentation versus time for each sample type-- this shows if the rate of alcohol production changes as the brewing time increases
```{r Rate of Change of Specific Gravity Over Time by Source}
# Calculate rate of change in Specific Gravity
# MergedSpecificGravityData <- MergedSpecificGravityData %>%
# group_by(SampleID) %>%
# mutate(SGRate = c(NA, diff(SpecificGravity) / diff(Time)))
# Filter missing values to allow connected lines
# MergedSpecificGravityData <- MergedSpecificGravityData %>%
# filter(!is.na(SGRate) & !is.na(Time))

# Plot with facets by Source and colors by SampleID
# ggplot(MergedSpecificGravityData, aes(x = Time, y = SGRate, color = as.factor(SampleID), group = SampleID)) +
# geom_line(size = 1, na.rm = TRUE) + 
# geom_point(size = 2) +  
# facet_grid(cols = vars(Source)) +  # Facet by Source
# labs(x = "Time",
# y = "Specific Gravity Rate of Change",
# color = "Sample ID",  
# title = "Rate of Change of Specific Gravity Over Time by Source") +
# theme_minimal(base_size = 12) +
# theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
# strip.text = element_text(size = 10, face = "bold"),
# axis.text.x = element_text(angle = 0, hjust = 1))

```

# Making a graph to show how long each brew took to reach the final SG
```{r Completion Time by Source}
# Calculate completion time for each SampleID
# completion_times <- MergedSpecificGravityData %>%
# group_by(SampleID, Source) %>%  # Include Source for grouping
# filter(SpecificGravity == min(SpecificGravity, na.rm = TRUE)) %>%
# summarize(Completion_Time = min(Time), .groups = "drop")

# Plot of Completion Times without facets
# ggplot(completion_times, aes(x = factor(SampleID), y = Completion_Time, color = Source)) +
# geom_point(size = 4) +
# geom_text(aes(label = round(Completion_Time, 1)), vjust = -0.75, hjust = 0.75, size = 5, color = "black") +
# labs(title = "Completion Time by Source and Sample ID",x = "Sample ID", y = "Completion Time (hours)", color = "Source") +
# theme_minimal(base_size = 12) +
# theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 14), strip.text = element_text(size = 10, face = "bold"), axis.text.x = element_text(angle = 45, hjust = 1),
# legend.position = "right")
```


# Finding out the atenuation of the sample this will identify the efficency of the yeast strain by comparing the sugar content in the initial wart to the amount of sugars left over giving a percent of sugars consumed and converted to alcohol or CO2
```{r Apparent Attenuation by Source}
# Calculate Apparent Attenuation for Each Sample
AttenuationData <- MergedSpecificGravityData %>%
group_by(Source , BrothType , GrowthTempC) %>%  # Include Source for grouping
summarize(InitialSG = max(SpecificGravity, na.rm = TRUE),  # Initial SG is the max
FinalSG = min(SpecificGravity, na.rm = TRUE),    # Final SG is the min
.groups = "drop") %>%
mutate(ApparentAttenuation = ((InitialSG - FinalSG) / (InitialSG - 1)) * 100)

# Plot Apparent Attenuation without facets
ggplot(AttenuationData, aes(x = Source, y = ApparentAttenuation, color = BrothType , shape = as.factor(GrowthTempC))) +
geom_point(size = 4) +  # Plot points
coord_cartesian(ylim = c(0 , 100)) +
geom_text(aes(label = round(ApparentAttenuation, 1)), vjust = -0.5, hjust = 1.5, size = 3.25, color = "black") +  # Add text labels above points
labs(title = "Apparent Attenuation (%) by Source, Broth Type and Temperature", x = "Source", y = "Apparent Attenuation (%)", color = "Broth Type") +
scale_x_discrete(drop = TRUE) +  # Drop unused levels in x-axis
theme_minimal(base_size = 12) +
theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 14), strip.text = element_text(size = 10, face = "bold"), axis.text.x = element_text(angle = 0, hjust = 0.5),
legend.position = "right")
```

\newpage

# Bibliography
