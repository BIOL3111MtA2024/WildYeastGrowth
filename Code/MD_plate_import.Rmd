---
title: "Import and fit microbial plate growth data"
author: "Maximilian Berthold, Douglas A. Campbell"
date: "`r format(Sys.Date())`"
output:
  html_document:
    df_print: paged
    code_folding: hide
---

This .Rmd imports Molecular Device Absorbance data, with data reorganized into columns labelled by treatment.

```{r load libraries, echo=FALSE, message = FALSE, warning = FALSE} 
# libraries; Note check actual dependencies
library(tidyverse) #core tidyverse packages
library(growthrates)

```


# Settings for file import

# Note: The .tsv file exported from the Molecular Dynamics software with encoding UTF16LE had embedded null characters that caused problems upon import.
As a hacked solution, download the .tsv from 'Teams'.
Import the .tsv into a new GoogleSheet.
Delete the first two rows of the file.
Export from GoogleSheet as .csv.
Move the .csv to the .Rproj folder.
A better way would be code to read the problematic UTF16LE file with null characters.
The issue relates to a complex file structure exported from Molecular Dynamics software.
```{r variable names for file import & processing MOLECULAR DEVICES}
Project <- "WildYeast"

#set variables for file import & processing
DataPath <- file.path("..", "Data", "RawData", fsep = .Platform$file.sep)
file_id <- ".csv"

# DataOneDrive <- "~/OneDrive - Mount Allison University/BIOL2201_2024/StudentDataTest"

```


```{r read metadata}
# left join
```

# List Data file(s)
```{r datafiles}
DataFiles <- list.files(path = DataPath, pattern = file_id, full.names = TRUE)

DataFiles

FileEncodeMD <- as.character(guess_encoding(file = DataFiles[1])[1,1])
FileEncodeMD
```

# Read ODData file(s) into form readable by R
```{r dataread}
ODData <- readr::read_csv(file =  DataFiles[1])

head(ODData)


#data.table::fread(text = readLines(DataFiles[1], skipNul = T))


```


```{r read all files}
#code for reading multiple files, if needed
# read_delim_plus <- function(flnm, delimiter, headerrows, fileencode){read_delim(flnm, delim = delimiter,  col_names = TRUE,  skip = headerrows, escape_double = FALSE,  locale = locale(encoding = fileencode), trim_ws = TRUE) |>
#     mutate(Filename = flnm)
#   }
# 
# ODData <- DataFiles |>
#   map_df(~read_delim_plus(flnm = ., delimiter = DelimiterMD,  headerrows = HeaderRowsMD,  fileencode = FileEncodeMD))
# 
# head(ODData)
```

# Molecular Dynamics exports problematic variable names; fix them
```{r variable names}
colnames(ODData)
```

```{r rename varible}
library(dplyr)

# Rename column using pattern matching
ODData <- ODData %>%
  rename_with(~ gsub("Temperature.*", "Temp_C", .x))  # Replace any name starting with "Temperature"
```
fart

```{r verify rename worked}
head(ODData)
```

# Lost labels for OD680 & OD720 in hacked import; regenerate them.

```{r OD labels}

#remove blank rows by filtering out rows where Temp_C is NA
ODData <- ODData |>
  filter(!is.na(Temp_C))

#this is a hack solution, knowing there are only 15 rows of data
#better way would be to keep the OD settings during import
ODData <- ODData |>
  mutate(nm = ifelse(row_number() %in% c(1:15), 680, 720), .before = Time)

head(ODData)
```


# For plotting it is easier to have data in 'long' format, where Well becomes a Value of a Variable, rather than a separate variable for each well.
```{r ODData long}
library(tidyr)
library(tidyverse) 
library(growthrates)

ODDataLong <- pivot_longer(ODData, cols = -c(nm, Time, Temp_C), names_to = "Well", values_to = "OD")

ODDataLong |>
  ggplot() +
  geom_point(aes(x = Time, y = OD)) +
  facet_grid(cols = vars(nm))

head(ODDataLong)
```



```{r save rds}
saveRDS(ODDataLong, file = file.path("..", "Data", "ProcessedData", "ODDataLong.rds"))
```

```{r}
View(ODDataLong)
```

```{r}
View(ATMetaData)
```


```{r}
library(dplyr)

# Merge ODData with ATMetaData
Merged_ATData <- ODDataLong %>%
  left_join(ATMetaData, by = "Well")

```

```{r}
library(lubridate)

# Convert Time to measurement #
Merged_ATData <- Merged_ATData %>%
  mutate(Time_numeric = as.numeric(hms(Time))/3600)  
```

```{r}
View(Merged_ATData)
```

```{r}
library(dplyr)

# Exclude wells G10, G11, G12, H10, H11, H12
Merged_ATData <- Merged_ATData %>%
  filter(!Well %in% c("G10", "G11", "G12", "H10", "H11", "H12"))

# Verify
table(Merged_ATData$Well) 
```


```{r}
# Filter data for OD 680 nm
Merged_ATData_680 <- Merged_ATData %>%
  filter(nm == 680)

# Filter data for OD 720 nm
Merged_ATData_720 <- Merged_ATData %>%
  filter(nm == 720)
```

```{r}
library(dplyr)
library(lubridate)

Merged_ATData <- Merged_ATData %>%
  mutate(Time_numeric = as.numeric(hms(Time)) / 3600)  # Converts to hours
```

```{r}
#Verify dataset structure
str(Merged_ATData)  
head(Merged_ATData) 
```
```{r}
library(dplyr)
library(ggplot2)
ggplot(Merged_ATData_720, aes(x = Time_numeric, y = OD, color = as.factor(Ethanol_Percent), group = Well)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ Sample_ID) + 
  labs(
    title = "Growth Curves for Each Sample (OD at 720 nm)",
    x = "Time (hours)", 
    y = "Optical Density (OD720)",
    color = "Ethanol (%)"
  ) +
  theme_minimal() +
  theme(
    text = element_text(size = 12),
    legend.position = "bottom"  
  )
```
```{r}
ggplot(Merged_ATData_680, aes(x = Time_numeric, y = OD, color = as.factor(Ethanol_Percent), group = Well)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ Sample_ID) +
  labs(
    title = "Growth Curves for Each Sample (OD at 680 nm)",
    x = "Time (hours)",
    y = "Optical Density (OD680)",
    color = "Ethanol (%)"
  ) +
  theme_minimal() +
  theme(
    text = element_text(size = 12),
    legend.position = "bottom"
  ) +
  scale_x_continuous(
    breaks = Merged_ATData_680$Time_numeric[Merged_ATData_680$Time_numeric %% 0.25 == 0] %>% unique() %>% sort()
  )
```

```{r}
Merged_ATData_clean <- Merged_ATData |> 
  filter(!is.na(Time_numeric), !is.na(nm), is.finite(Time_numeric), is.finite(nm))
```

```{r}
View(Merged_ATData_clean
     )
```

```{r}
# Count rows in each group
Merged_ATData |> 
  group_by(nm, Well) |> 
  summarise(count = n()) |> 
  arrange(count)

```

```{r}
# Load necessary libraries
library(dplyr)
library(tidyr)
library(purrr)
library(growthrates)

# Step 2: Spline Fitting and Parameter Extraction
SplineRates_nest <- Merged_ATData |> 
  group_by(nm, Well) |> 
  nest() |> 
  mutate(
    # Fit spline with error handling
    SplineFit = purrr::map(data, ~tryCatch(
      growthrates::fit_spline(.$Time_numeric, .$OD),  # Fit spline
      error = function(e) NULL  # Handle errors gracefully
    )),
    # Extract maximum growth rate (mumax) or return NA if fit fails
    mumax = purrr::map_dbl(SplineFit, ~if (!is.null(.)) pluck(., "par", "mumax") else NA_real_),
    # Extract R-squared value or return NA if fit fails
    rsquared = purrr::map_dbl(SplineFit, ~if (!is.null(.)) pluck(., "rsquared") else NA_real_)# Averaging separately for 608 nm and 720 nm
    ) |> 
  ungroup()

# Step 3: View and Save Results
# Select and display key results
SplineRates_results <- SplineRates_nest |> 
  select(nm, Well, mumax, rsquared)

# View the results
print(SplineRates_results)

# Save the results to a CSV file (optional)
write.csv(SplineRates_results, "SplineRates_results.csv", row.names = FALSE)

```
#NEED to left join this with metadata so i can find average mumax and r squared

```{r}
library(dplyr)

# Merge ODData with ATMetaData
Merged_ATMetaData_MuMax <- SplineRates_results %>%
  left_join(ATMetaData, by = "Well")
View(Merged_ATMetaData_MuMax)
```

```{r}
# Remove rows with any NA values
Merged_ATMetaData_MuMax_clean <- na.omit(Merged_ATMetaData_MuMax)

# Check the result
head(Merged_ATMetaData_MuMax_clean)
```

```{r}
# Load necessary library
library(ggplot2)

# Plot with larger dimensions and improved readability
ggplot(data_680, aes(x = Ethanol_Percent, y = mumax, color = as.factor(Replicate))) +
  geom_point(size = 3) +                            # Larger points
  geom_line(size = 1, aes(group = Replicate)) +     # Separate line for each replicate
  facet_wrap(~ Sample_ID, scales = "free", ncol = 2) + # Two columns for better spacing
  labs(
    x = "Ethanol Concentration (%v/v)", 
    y = "mumax",
    color = "Replicate",                            # Legend title for replicates
    title = "mumax vs Ethanol Concentration at 680 nm by Replicate"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),                   # Remove grid lines
    axis.title = element_text(size = 18),           # Larger axis titles
    axis.text = element_text(size = 14),            # Larger axis text
    strip.text = element_text(size = 16, face = "bold"), # Larger facet labels
    legend.text = element_text(size = 14),          # Larger legend text
    legend.title = element_text(size = 16),         # Larger legend title
    panel.border = element_rect(color = "black", fill = NA), # Add border around panels
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5), # Bold, centered title
    strip.background = element_rect(fill = "lightgray", color = "black") # Gray background for facet labels
  )

# Save the plot with larger dimensions
ggsave("mumax_680nm_triplicate_large_plot.png", width = 16, height = 10, dpi = 300)




```


```{r}
# Group by Sample_ID, Ethanol_Percent, and Time_numeric to average mumax and rsquared
MuMax_Averaged <- SplineRates_nest |> 
  group_by(Sample_ID, Ethanol_Percent, Time_numeric) |> 
  summarise(
    avg_mumax = mean(mumax, na.rm = TRUE),    # Average mumax
    avg_rsquared = mean(rsquared, na.rm = TRUE),  # Average rsquared
    sd_mumax = sd(mumax, na.rm = TRUE),      # Standard deviation of mumax
    sd_rsquared = sd(rsquared, na.rm = TRUE), # Standard deviation of rsquared
    .groups = "drop"                         # Ungroup after summarising
  )

# View the results
print(MuMax_Averaged)

# Save to CSV (optional)
write.csv(MuMax_Averaged, "MuMax_Averaged_Results.csv", row.names = FALSE)

```




```{r}
# View the results
print(SplineRates_results)
View(SplineRates_results
     )
```




```{r}
# Load necessary libraries
library(dplyr)
library(purrr)
library(growthrates)
library(lattice)
library(deSolve)
library(tidyr)


# Fit splines and extract growth parameters
SplineRates_nest <- Merged_ATData |>  # Replace ODDataLong with your actual dataset
  nest(data = -c(nm, Well)) |>    # Group by 'nm' and 'Well', nest data
  mutate(
    # Fit spline to each group's data
    SplineFit = purrr::map(data, ~growthrates::fit_spline(.$Time_numeric, .$nm)),

    # Extract maximum growth rate (mumax)
    mumax = purrr::map_dbl(SplineFit, ~pluck(., "par", "mumax")),

    # Extract R-squared value (fit quality)
    rsquared = purrr::map_dbl(SplineFit, ~pluck(., "rsquared"))
  )

# View the resulting tibble
SplineRates_nest

```

```



```{r growthrates package spline fit}
#SplineRates_nest <- ODDataLong |>
  #nest(data = -c(nm , Well)) |>
 # mutate(SplineFit = purrr::map(data, ~growthrates::fit_spline(.$Time, .$OD))) |>
 # mutate(mumax = purrr::map(SplineFit, ~pluck(., "par", "mumax"))) |>
 # mutate(rsquared = purrr::map(SplineFit, ~pluck(., "rsquared"))) 

```

```{r export data}
# write_csv(x = SplineRates_nest |> select(c(Media, Treatment, mumax, rsquared)), file = "MuMaxEstimates.csv")
```

