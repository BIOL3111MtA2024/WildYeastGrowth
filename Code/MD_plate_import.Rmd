---
title: "Import and fit microbial plate growth data"
author: "Maximilian Berthold, Douglas A. Campbell"
date: "`r format(Sys.Date())`"
output:
  html_document:
    df_print: paged
    code_folding: hide
---

This .Rmd imports Molecular Device Absorbance data, with data reorganized into columns labelled by treatment.

```{r load libraries, echo=FALSE, message = FALSE, warning = FALSE} 
# libraries; Note check actual dependencies
library(tidyverse) #core tidyverse packages
library(growthrates)

```


# Settings for file import

# Note: The .tsv file exported from the Molecular Dynamics software with encoding UTF16LE had embedded null characters that caused problems upon import.
As a hacked solution, download the .tsv from 'Teams'.
Import the .tsv into a new GoogleSheet.
Delete the first two rows of the file.
Export from GoogleSheet as .csv.
Move the .csv to the .Rproj folder.
A better way would be code to read the problematic UTF16LE file with null characters.
The issue relates to a complex file structure exported from Molecular Dynamics software.
```{r variable names for file import & processing MOLECULAR DEVICES}
Project <- "WildYeast"

#set variables for file import & processing
DataPath <- file.path("..", "Data", "RawData", fsep = .Platform$file.sep)
file_id <- ".csv"

# DataOneDrive <- "~/OneDrive - Mount Allison University/BIOL2201_2024/StudentDataTest"

```


```{r read metadata}
# left join
```

# List Data file(s)
```{r datafiles}
DataFiles <- list.files(path = DataPath, pattern = file_id, full.names = TRUE)

DataFiles

FileEncodeMD <- as.character(guess_encoding(file = DataFiles[1])[1,1])
FileEncodeMD
```

# Read ODData file(s) into form readable by R
```{r dataread}
ODData <- readr::read_csv(file =  DataFiles[1])

head(ODData)


#data.table::fread(text = readLines(DataFiles[1], skipNul = T))


```


```{r read all files}
#code for reading multiple files, if needed
# read_delim_plus <- function(flnm, delimiter, headerrows, fileencode){read_delim(flnm, delim = delimiter,  col_names = TRUE,  skip = headerrows, escape_double = FALSE,  locale = locale(encoding = fileencode), trim_ws = TRUE) |>
#     mutate(Filename = flnm)
#   }
# 
# ODData <- DataFiles |>
#   map_df(~read_delim_plus(flnm = ., delimiter = DelimiterMD,  headerrows = HeaderRowsMD,  fileencode = FileEncodeMD))
# 
# head(ODData)
```

# Molecular Dynamics exports problematic variable names; fix them
```{r variable names}
colnames(ODData)
```

```{r rename varible}
library(dplyr)

# Rename column using pattern matching
ODData <- ODData %>%
  rename_with(~ gsub("Temperature.*", "Temp_C", .x))  # Replace any name starting with "Temperature"
```
fart

```{r verify rename worked}
head(ODData)
```

# Lost labels for OD680 & OD720 in hacked import; regenerate them.

```{r OD labels}

#remove blank rows by filtering out rows where Temp_C is NA
ODData <- ODData |>
  filter(!is.na(Temp_C))

#this is a hack solution, knowing there are only 15 rows of data
#better way would be to keep the OD settings during import
ODData <- ODData |>
  mutate(nm = ifelse(row_number() %in% c(1:15), 680, 720), .before = Time)

head(ODData)
```


# For plotting it is easier to have data in 'long' format, where Well becomes a Value of a Variable, rather than a separate variable for each well.
```{r ODData long}
library(tidyr)
library(tidyverse) 
library(growthrates)

ODDataLong <- pivot_longer(ODData, cols = -c(nm, Time, Temp_C), names_to = "Well", values_to = "OD")

ODDataLong |>
  ggplot() +
  geom_point(aes(x = Time, y = OD)) +
  facet_grid(cols = vars(nm))

head(ODDataLong)
```



```{r save rds}
saveRDS(ODDataLong, file = file.path("..", "Data", "ProcessedData", "ODDataLong.rds"))
```

```{r}
View(ODDataLong)
```

```{r}
View(ATMetaData)
```


```{r}
library(dplyr)

# Merge ODData with ATMetaData
Merged_ATData <- ODDataLong %>%
  left_join(ATMetaData, by = "Well")

```

```{r}
library(lubridate)

# Convert Time to measurement #
Merged_ATData <- Merged_ATData %>%
  mutate(Time_numeric = as.numeric(hms(Time))/3600)  
```

```{r}
View(Merged_ATData)
```

```{r}
library(dplyr)

# Exclude wells G10, G11, G12, H10, H11, H12
Merged_ATData <- Merged_ATData %>%
  filter(!Well %in% c("G10", "G11", "G12", "H10", "H11", "H12"))

# Verify
table(Merged_ATData$Well) 
```


```{r}
# Filter data for OD 680 nm
Merged_ATData_680 <- Merged_ATData %>%
  filter(nm == 680)

# Filter data for OD 720 nm
Merged_ATData_720 <- Merged_ATData %>%
  filter(nm == 720)
```

```{r}
library(dplyr)
library(lubridate)

Merged_ATData <- Merged_ATData %>%
  mutate(Time_numeric = as.numeric(hms(Time)) / 3600)  # Converts to hours
```

```{r}
#Verify dataset structure
str(Merged_ATData)  
head(Merged_ATData) 
```
```{r}
library(dplyr)
library(ggplot2)
ggplot(Merged_ATData_720, aes(x = Time_numeric, y = OD, color = as.factor(Ethanol_Percent), group = Well)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ Sample_ID) + 
  labs(
    title = "Growth Curves for Each Sample (OD at 720 nm)",
    x = "Time (hours)", 
    y = "Optical Density (OD720)",
    color = "Ethanol (%)"
  ) +
  theme_minimal() +
  theme(
    text = element_text(size = 12),
    legend.position = "bottom"  
  )
```
```{r}
ggplot(Merged_ATData_680, aes(x = Time_numeric, y = OD, color = as.factor(Ethanol_Percent), group = Well)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ Sample_ID) +
  labs(
    title = "Growth Curves for Each Sample (OD at 680 nm)",
    x = "Time (hours)",
    y = "Optical Density (OD680)",
    color = "Ethanol (%)"
  ) +
  theme_minimal() +
  theme(
    text = element_text(size = 12),
    legend.position = "bottom"
  ) +
  scale_x_continuous(
    breaks = Merged_ATData_680$Time_numeric[Merged_ATData_680$Time_numeric %% 0.25 == 0] %>% unique() %>% sort()
  )
```

```{r}
Merged_ATData_clean <- Merged_ATData |> 
  filter(!is.na(Time_numeric), !is.na(nm), is.finite(Time_numeric), is.finite(nm))
```

```{r}
View(Merged_ATData_clean
     )
```

```{r}
# Count rows in each group
Merged_ATData |> 
  group_by(nm, Well) |> 
  summarise(count = n()) |> 
  arrange(count)

```

```{r}
# Load necessary libraries
library(dplyr)
library(tidyr)
library(purrr)
library(growthrates)

# Step 2: Spline Fitting and Parameter Extraction
SplineRates_nest <- Merged_ATData |> 
  group_by(nm, Well) |> 
  nest() |> 
  mutate(
    # Fit spline with error handling
    SplineFit = purrr::map(data, ~tryCatch(
      growthrates::fit_spline(.$Time_numeric, .$OD),  # Fit spline
      error = function(e) NULL  # Handle errors gracefully
    )),
    # Extract maximum growth rate (mumax) or return NA if fit fails
    mumax = purrr::map_dbl(SplineFit, ~if (!is.null(.)) pluck(., "par", "mumax") else NA_real_),
    # Extract R-squared value or return NA if fit fails
    rsquared = purrr::map_dbl(SplineFit, ~if (!is.null(.)) pluck(., "rsquared") else NA_real_)# Averaging separately for 608 nm and 720 nm
    ) |> 
  ungroup()

# Step 3: View and Save Results
# Select and display key results
SplineRates_results <- SplineRates_nest |> 
  select(nm, Well, mumax, rsquared)

# View the results
print(SplineRates_results)

# Save the results to a CSV file (optional)
write.csv(SplineRates_results, "SplineRates_results.csv", row.names = FALSE)

```
#NEED to left join this with metadata so i can find average mumax and r squared

```{r}
library(dplyr)

# Merge ODData with ATMetaData
Merged_ATMetaData_MuMax <- SplineRates_results %>%
  left_join(ATMetaData, by = "Well")
View(Merged_ATMetaData_MuMax)
```

```{r}
# Remove rows with any NA values
Merged_ATMetaData_MuMax_clean <- na.omit(Merged_ATMetaData_MuMax)

# Check the result
head(Merged_ATMetaData_MuMax_clean)

View(Merged_ATMetaData_MuMax_clean)

```

```{r}
plot_sample_dual_nm <- function(data, sample_id) {
  # Filter the dataset for the given Sample_ID and the desired nm values
  sample_data <- data %>%
    filter(Sample_ID == sample_id, nm %in% c(680, 720))
  
  # Check if the filtered data is valid
  if (nrow(sample_data) == 0) {
    stop("No data available for the given Sample_ID and nm values.")
  }
  
  # Generate the plot
  plot <- ggplot(sample_data, aes(x = Ethanol_Percent, y = mumax, color = as.factor(nm))) +
    geom_point(size = 3, shape = 21, aes(fill = as.factor(nm)), show.legend = TRUE) +
    geom_smooth(method = "lm", se = FALSE, aes(color = as.factor(nm)), size = 1) +
    facet_wrap(~ nm, scales = "free_y", ncol = 1) +
    scale_x_continuous(
      limits = c(0, 13),
      breaks = seq(0, 13, by = 1),
      expand = c(0, 0)
    ) +
    scale_y_continuous(
      limits = c(0, 0.4),
      breaks = seq(0, , by = 0.1),
      expand = c(0, 0)) +
    labs(
      x = "Ethanol Concentration (%, v/v)", 
      y = expression(mu[max]),  # Subscript "max"
      title = bquote(mu[max] ~ "vs. Ethanol Concentration (%, v/v) for Sample" ~ .(sample_id))
    ) +
    theme_minimal() +
    theme(
      panel.grid.major = element_line(color = "gray90"),                # Add light grid lines for reference
      panel.grid.minor = element_blank(),                               # Remove minor grid lines
      axis.title = element_text(size = 16),                             # Larger axis titles
      axis.text = element_text(size = 14),                              # Larger axis text
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5), # Bold and centered title
      strip.text = element_text(size = 14, face = "bold"),              # Facet label styling
      panel.border = element_rect(color = "black", fill = NA)           # Border around facets
    ) +
    scale_color_manual(values = c("red", "blue"), labels = c("680 nm", "720 nm")) +
    scale_fill_manual(values = c("red", "blue"), labels = c("680 nm", "720 nm")) +
    guides(fill = guide_legend(title = "Wavelength (nm)"), 
           color = guide_legend(title = "Wavelength (nm)"))
  
  return(plot)
}

# Example Usage
sample_id <- 18
plot <- plot_sample_dual_nm(Merged_ATMetaData_MuMax_clean, sample_id)
print(plot)

# Save the plot
ggsave(
  filename = paste0("mumax_dual_nm_sample_", sample_id, ".png"),
  plot = plot,
  width = 8, height = 10, dpi = 300
)
```
```{r}
plot_sample_dual_nm <- function(data, sample_id) {
  # Filter the dataset for the given Sample_ID and the desired nm values
  sample_data <- data %>%
    filter(Sample_ID == sample_id, nm %in% c(680, 720))
  
  # Check if the filtered data is valid
  if (nrow(sample_data) == 0) {
    stop("No data available for the given Sample_ID and nm values.")
  }
  
  # Generate the plot
  plot <- ggplot(sample_data, aes(x = Ethanol_Percent, y = mumax, color = as.factor(nm))) +
    geom_point(size = 3, shape = 21, aes(fill = as.factor(nm)), show.legend = TRUE) +
    geom_smooth(method = "lm", se = FALSE, aes(color = as.factor(nm)), size = 1) +
    facet_wrap(~ nm, scales = "free_y", ncol = 1) +
    scale_x_continuous(
      limits = c(0, 13),
      breaks = seq(0, 13, by = 1),
      expand = c(0, 0)
    ) +
    scale_y_continuous(
      limits = c(0, 0.4),
      breaks = seq(0, , by = 0.1),
      expand = c(0, 0)) +
    labs(
      x = "Ethanol Concentration (%, v/v)", 
      y = expression(mu[max]),  # Subscript "max"
      title = bquote(mu[max] ~ "vs. Ethanol Concentration (%, v/v) for Sample" ~ .(sample_id))
    ) +
    theme_minimal() +
    theme(
      panel.grid.major = element_line(color = "gray90"),                # Add light grid lines for reference
      panel.grid.minor = element_blank(),                               # Remove minor grid lines
      axis.title = element_text(size = 16),                             # Larger axis titles
      axis.text = element_text(size = 14),                              # Larger axis text
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5), # Bold and centered title
      strip.text = element_text(size = 14, face = "bold"),              # Facet label styling
      panel.border = element_rect(color = "black", fill = NA)           # Border around facets
    ) +
    scale_color_manual(values = c("red", "blue"), labels = c("680 nm", "720 nm")) +
    scale_fill_manual(values = c("red", "blue"), labels = c("680 nm", "720 nm")) +
    guides(fill = guide_legend(title = "Wavelength (nm)"), 
           color = guide_legend(title = "Wavelength (nm)"))
  
  return(plot)
}

# Example Usage
sample_id <- 19
plot <- plot_sample_dual_nm(Merged_ATMetaData_MuMax_clean, sample_id)
print(plot)

# Save the plot
ggsave(
  filename = paste0("mumax_dual_nm_sample_", sample_id, ".png"),
  plot = plot,
  width = 8, height = 10, dpi = 300
)
```
```{r}
plot_sample_dual_nm <- function(data, sample_id) {
  # Filter the dataset for the given Sample_ID and the desired nm values
  sample_data <- data %>%
    filter(Sample_ID == sample_id, nm %in% c(680, 720))
  
  # Check if the filtered data is valid
  if (nrow(sample_data) == 0) {
    stop("No data available for the given Sample_ID and nm values.")
  }
  
  # Generate the plot
  plot <- ggplot(sample_data, aes(x = Ethanol_Percent, y = mumax, color = as.factor(nm))) +
    geom_point(size = 3, shape = 21, aes(fill = as.factor(nm)), show.legend = TRUE) +
    geom_smooth(method = "lm", se = FALSE, aes(color = as.factor(nm)), size = 1) +
    facet_wrap(~ nm, scales = "free_y", ncol = 1) +
    scale_x_continuous(
      limits = c(0, 13),
      breaks = seq(0, 13, by = 1),
      expand = c(0, 0)
    ) +
    scale_y_continuous(
      limits = c(0, 0.8),
      breaks = seq(0, , by = 0.2),
      expand = c(0, 0)) +
    labs(
      x = "Ethanol Concentration (%, v/v)", 
      y = expression(mu[max]),  # Subscript "max"
      title = bquote(mu[max] ~ "vs. Ethanol Concentration (%, v/v) for Sample" ~ .(sample_id))
    ) +
    theme_minimal() +
    theme(
      panel.grid.major = element_line(color = "gray90"),                # Add light grid lines for reference
      panel.grid.minor = element_blank(),                               # Remove minor grid lines
      axis.title = element_text(size = 16),                             # Larger axis titles
      axis.text = element_text(size = 14),                              # Larger axis text
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5), # Bold and centered title
      strip.text = element_text(size = 14, face = "bold"),              # Facet label styling
      panel.border = element_rect(color = "black", fill = NA)           # Border around facets
    ) +
    scale_color_manual(values = c("red", "blue"), labels = c("680 nm", "720 nm")) +
    scale_fill_manual(values = c("red", "blue"), labels = c("680 nm", "720 nm")) +
    guides(fill = guide_legend(title = "Wavelength (nm)"), 
           color = guide_legend(title = "Wavelength (nm)"))
  
  return(plot)
}

# Example Usage
sample_id <- 41
plot <- plot_sample_dual_nm(Merged_ATMetaData_MuMax_clean, sample_id)
print(plot)

# Save the plot
ggsave(
  filename = paste0("mumax_dual_nm_sample_", sample_id, ".png"),
  plot = plot,
  width = 8, height = 10, dpi = 300
)
```
```{r}
plot_sample_dual_nm <- function(data, sample_id) {
  # Filter the dataset for the given Sample_ID and the desired nm values
  sample_data <- data %>%
    filter(Sample_ID == sample_id, nm %in% c(680, 720))
  
  # Check if the filtered data is valid
  if (nrow(sample_data) == 0) {
    stop("No data available for the given Sample_ID and nm values.")
  }
  
  # Generate the plot
  plot <- ggplot(sample_data, aes(x = Ethanol_Percent, y = mumax, color = as.factor(nm))) +
    geom_point(size = 3, shape = 21, aes(fill = as.factor(nm)), show.legend = TRUE) +
    geom_smooth(method = "lm", se = FALSE, aes(color = as.factor(nm)), size = 1) +
    facet_wrap(~ nm, scales = "free_y", ncol = 1) +
    scale_x_continuous(
      limits = c(0, 13),
      breaks = seq(0, 13, by = 1),
      expand = c(0, 0)
    ) +
    scale_y_continuous(
      limits = c(0, 0.8),
      breaks = seq(0, , by = 0.2),
      expand = c(0, 0)) +
    labs(
      x = "Ethanol Concentration (%, v/v)", 
      y = expression(mu[max]),  # Subscript "max"
      title = bquote(mu[max] ~ "vs. Ethanol Concentration (%, v/v) for Sample" ~ .(sample_id))
    ) +
    theme_minimal() +
    theme(
      panel.grid.major = element_line(color = "gray90"),                # Add light grid lines for reference
      panel.grid.minor = element_blank(),                               # Remove minor grid lines
      axis.title = element_text(size = 16),                             # Larger axis titles
      axis.text = element_text(size = 14),                              # Larger axis text
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5), # Bold and centered title
      strip.text = element_text(size = 14, face = "bold"),              # Facet label styling
      panel.border = element_rect(color = "black", fill = NA)           # Border around facets
    ) +
    scale_color_manual(values = c("red", "blue"), labels = c("680 nm", "720 nm")) +
    scale_fill_manual(values = c("red", "blue"), labels = c("680 nm", "720 nm")) +
    guides(fill = guide_legend(title = "Wavelength (nm)"), 
           color = guide_legend(title = "Wavelength (nm)"))
  
  return(plot)
}

# Example Usage
sample_id <- 43
plot <- plot_sample_dual_nm(Merged_ATMetaData_MuMax_clean, sample_id)
print(plot)

# Save the plot
ggsave(
  filename = paste0("mumax_dual_nm_sample_", sample_id, ".png"),
  plot = plot,
  width = 8, height = 10, dpi = 300
)
```
```{r}
plot_sample_dual_nm <- function(data, sample_id) {
  # Filter the dataset for the given Sample_ID and the desired nm values
  sample_data <- data %>%
    filter(Sample_ID == sample_id, nm %in% c(680, 720))
  
  # Check if the filtered data is valid
  if (nrow(sample_data) == 0) {
    stop("No data available for the given Sample_ID and nm values.")
  }
  
  # Generate the plot
  plot <- ggplot(sample_data, aes(x = Ethanol_Percent, y = mumax, color = as.factor(nm))) +
    geom_point(size = 3, shape = 21, aes(fill = as.factor(nm)), show.legend = TRUE) +
    geom_smooth(method = "lm", se = FALSE, aes(color = as.factor(nm)), size = 1) +
    facet_wrap(~ nm, scales = "free_y", ncol = 1) +
    scale_x_continuous(
      limits = c(0, 13),
      breaks = seq(0, 13, by = 1),
      expand = c(0, 0)
    ) +
    scale_y_continuous(
      limits = c(-0.1, 0.1),
      breaks = seq(-0.1, 0.1, by = 0.05),
      expand = c(0, 0)) +
    labs(
      x = "Ethanol Concentration (%, v/v)", 
      y = expression(mu[max]),  # Subscript "max"
      title = bquote(mu[max] ~ "vs. Ethanol Concentration (%, v/v) for Sample" ~ .(sample_id))
    ) +
    theme_minimal() +
    theme(
      panel.grid.major = element_line(color = "gray90"),                # Add light grid lines for reference
      panel.grid.minor = element_blank(),                               # Remove minor grid lines
      axis.title = element_text(size = 16),                             # Larger axis titles
      axis.text = element_text(size = 14),                              # Larger axis text
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5), # Bold and centered title
      strip.text = element_text(size = 14, face = "bold"),              # Facet label styling
      panel.border = element_rect(color = "black", fill = NA)           # Border around facets
    ) +
    scale_color_manual(values = c("red", "blue"), labels = c("680 nm", "720 nm")) +
    scale_fill_manual(values = c("red", "blue"), labels = c("680 nm", "720 nm")) +
    guides(fill = guide_legend(title = "Wavelength (nm)"), 
           color = guide_legend(title = "Wavelength (nm)"))
  
  return(plot)
}

# Example Usage
sample_id <- 7
plot <- plot_sample_dual_nm(Merged_ATMetaData_MuMax_clean, sample_id)
print(plot)

# Save the plot
ggsave(
  filename = paste0("mumax_dual_nm_sample_", sample_id, ".png"),
  plot = plot,
  width = 8, height = 10, dpi = 300
)
```

```{r}
plot_sample_dual_nm <- function(data, sample_id) {
  # Filter the dataset for the given Sample_ID and the desired nm values
  sample_data <- data %>%
    filter(Sample_ID == sample_id, nm %in% c(680, 720))
  
  # Check if the filtered data is valid
  if (nrow(sample_data) == 0) {
    stop("No data available for the given Sample_ID and nm values.")
  }
  
  # Generate the plot
  plot <- ggplot(sample_data, aes(x = Ethanol_Percent, y = mumax, color = as.factor(nm))) +
    geom_point(size = 3, shape = 21, aes(fill = as.factor(nm)), show.legend = TRUE) +
    geom_smooth(method = "lm", se = FALSE, aes(color = as.factor(nm)), size = 1) +
    facet_wrap(~ nm, scales = "free_y", ncol = 1) +
    scale_x_continuous(
      limits = c(0, 13),
      breaks = seq(0, 13, by = 1),
      expand = c(0, 0)
    ) +
    scale_y_continuous(
      limits = c(-0.1, 0.1),
      breaks = seq(-0.1, 0.1, by = 0.05),
      expand = c(0, 0)) +
    labs(
      x = "Ethanol Concentration (%, v/v)", 
      y = expression(mu[max]),  # Subscript "max"
      title = bquote(mu[max] ~ "vs. Ethanol Concentration (%, v/v) for Sample" ~ .(sample_id))
    ) +
    theme_minimal() +
    theme(
      panel.grid.major = element_line(color = "gray90"),                # Add light grid lines for reference
      panel.grid.minor = element_blank(),                               # Remove minor grid lines
      axis.title = element_text(size = 16),                             # Larger axis titles
      axis.text = element_text(size = 14),                              # Larger axis text
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5), # Bold and centered title
      strip.text = element_text(size = 14, face = "bold"),              # Facet label styling
      panel.border = element_rect(color = "black", fill = NA)           # Border around facets
    ) +
    scale_color_manual(values = c("red", "blue"), labels = c("680 nm", "720 nm")) +
    scale_fill_manual(values = c("red", "blue"), labels = c("680 nm", "720 nm")) +
    guides(fill = guide_legend(title = "Wavelength (nm)"), 
           color = guide_legend(title = "Wavelength (nm)"))
  
  return(plot)
}

# Example Usage
sample_id <- 36
plot <- plot_sample_dual_nm(Merged_ATMetaData_MuMax_clean, sample_id)
print(plot)

# Save the plot
ggsave(
  filename = paste0("mumax_dual_nm_sample_", sample_id, ".png"),
  plot = plot,
  width = 8, height = 10, dpi = 300
)
```




